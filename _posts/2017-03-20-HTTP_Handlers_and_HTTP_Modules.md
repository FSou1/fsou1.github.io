---
layout: post
title: ASP.NET - HTTP Handler & HTTP Module
---

Тема хендлеров и модулей уже далеко не новая, однако, не теряет актуальности и поэтому сегодня хотелось бы поставить все точки над "и" в этом вопросе и раз и навсегда разобраться что же это такое, для чего и как используется.

**ASP.NET Handler** - это процесс (или endpoint), который запускается для обработки соответствующего неким критериям входящего HTTP запроса (таким критерием является расширение файла, который запрашивается). Наиболее известным handler'ом является обработчик запросов к .aspx страницам. 

В случае с пользовательскими сценариями, это может быть handler формирующий файл RSS (обрабатывающий запросы с расширением *.rss) или image server, который трансформирует изображения в зависимости от нужд (ресайзит).

**ASP.NET Module** - некая сборка (модуль), которая после подключения (регистрации) запускается для каждого входящего запроса и отрабатывает некую функциональность.

К примерам пользовательских модулей обычно относятся реализации логирования, сборка статистики и изменение ответа от сервера (это могут быть изменение http заголовков или response, например, для приведения его к унифицированному (единому) виду).

### Реализация HTTP Handler

Прежде чем имплементировать собственный handler нужно знать о том, что handler'ы бывают 2-х видов: синхронные (`IHttpHandler`) и асинхронные (`IHttpAsyncHandler`). Оба интерфейса содержат свойство `IsReusable`, значение которого показывает фабрике `IHttpHandlerFactory` (которая отвечает за их создание) возможность переиспользования уже созданного экземпляра обработчика для нескольких запросов, тем самым исключая его повторного создания и улучшая производительность. В противном случае обработчик будет создаваться для каждого входящего запроса.

Непосредственно сама логика работы обработчика (формирование ответа от сервера на входящий запрос) реализуется в наследуемом методе `void ProcessRequest(HttpContext context)`. 

Для регистрации (подключения) нашего обработчика нам потребуется прописать в web.config следующее:

```
<configuration>
    <system.web>
        <httpHandlers>
            <add verb="*" path="*.ext" type="SampleHandler, SampleHandlerAssembly" />
        </httpHandlers>
    </system.web>
</configuration>
```

Где:

1. verb - тип HTTP запроса;
2. path - условие (расширение файла, запрос к которому будет обрабатываться нашим handler'ом);
3. type - наименование обработчика (класса);

### Асинхронный HTTP Handler

В отличии от синхронного обработчика, который не возвращает ответ пользователю до тех пор, пока не завершит свою работу, асинхронный обработчик по природе своей призван запустить некое длительное по времени выполнение задание, результат выполнения которого пользователь не собирается дожидаться. 

С точки производительности ASP.NET приложения, асинхронные обработчики хороши тем, что после запуска длительного по выполнению задания (например, вызов удалённого сервера) ASP.NET возвращает использованный для этого поток обработчика обратно в пул потоков asp.net и может использовать его для обработки других запросов до тех пор, пока задание не будет выполнено и не получен результат. После этого, выполнение асинхронного обработчика будет продолжено. Такой подход уменьшает вероятность блокировки потоков и улучшает производительность приложения, т.к. кол-во одновременно выполняемых потоков ограничено. В случае большого кол-ва HTTP запросов к серверу, которые обрабатываются синхронными HTTP Handler'ами, есть вероятность отсутствия свободных потоков для обслуживания, что приведёт к задержкам.

Реализация асинхронного обработчика аналогична синхронному за тем лишь исключением, что вместо одного метода `ProcessRequest` требуется реализовать два: `BeginProcessRequest` и `EndProcessRequest`.

### Фабрика HTTP Handler'ов

Как я уже отмечал выше, за создание обработчиков отвечает `HttpHandlerFactory`, которую так же можно (если нужно) реализовать. Всё что для этого нужно, так это реализовать интерфейс `IHttpHandlerFactory` и зарегистрировать её в web.config'e:

```
<configuration>
    <system.webServer>
        <handlers>
            <add verb="GET,POST" path="*.sample" name="HandlerFactory" type="HandlerFactory"/>
        </handlers>
    </system.webServer>
</configuration>
```